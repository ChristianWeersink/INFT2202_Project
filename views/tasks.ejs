<% const title="Tasks" ; %>
    <%- include('header', {title: title}) %>

        <h1>
            <%= title %>
        </h1>

        <form id="taskForm" method="post">
            <label for="name">Name:</label>
            <input type="text" id="name" name="name" required><br>

            <label for="description">Description:</label>
            <textarea id="description" name="description"></textarea><br>

            <label for="category">Category:</label>
            <input type="text" id="category" name="category"><br>

            <label for="label">Label:</label>
            <input type="text" id="label" name="label"><br>

            <label for="dueDate">Due Date:</label>
            <input type="date" id="dueDate" name="dueDate"><br>

            <label for="priority">Priority Level: </label>
            <input type="number" id="priority" min="0" max="3" value="0">

            <input type="hidden" id="owner" name="owner" value="" readonly><br>

            <input type="submit" value="Create Task">
        </form>
        <div id="messages"></div>

        <!-- Display tasks -->
        <div id="tasks-container">
            <% tasks.forEach(task=> { %>
                <div class="task-item">
                    <h3>
                        <%= task.name %>
                    </h3>
                    <p>Description: <%= task.description %>
                    </p>
                    <p>Category: <%= task.category %>
                    </p>
                    <p>Label: <%= task.label %>
                    </p>
                    <p>Due Date: <%= task.dueDate %>
                    </p>
                    <p>Priority: <%= task.priority %>
                    </p>
                    <button id="<%=task._id %>" class="deleteButton">Delete</button>
                    <button class="updateButton" id="<%= task._id %>">Update</button>
                </div>
                <% }); %>
        </div>

        <!-- Pagination controls -->
        <div class="pagination">
            <% if (currentPage> 1) { %>
                <a href="/tasks?page=<%= currentPage - 1 %>">Previous</a>
                <% } %>
                    <span>Page <%= currentPage %></span>
                    <% if (tasks.length===5) { %>
                        <a href="/tasks?page=<%= currentPage + 1 %>">Next</a>
                        <% } %>
        </div>

        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script>
            // Access userInfo and set the owner field
            let userInfo = getCookie('user');
            let userParsed = JSON.parse(userInfo);

            $('#owner').val(userParsed._id);


            $('#taskForm').submit(function (event) {
                event.preventDefault(); // Prevent default form submission

                // Construct JSON object with form data
                const jsonData = {
                    name: $('#name').val(),
                    description: $('#description').val(),
                    category: $('#category').val(),
                    label: $('#label').val(),
                    dueDate: $('#dueDate').val(),
                    owner: $('#owner').val(),
                    priority: $('#priority').val()
                };
                console.log(jsonData);

                // Send JSON data to the server using AJAX
                $.ajax({
                    type: 'POST',
                    url: '/tasks',
                    contentType: 'application/json',
                    data: JSON.stringify(jsonData),
                    success: function (task) {
                        // Append the new task to the tasks container
                        const taskContainer = $('#tasks-container');
                        taskContainer.append(`
                        <div class="task-item">
                            <h3>${task.name}</h3>
                            <p>Description: ${task.description}</p>
                            <p>Category: ${task.category}</p>
                            <p>Label: ${task.label}</p>
                            <p>Due Date: ${task.dueDate}</p>
                            <p>Priority: ${task.priority}</p>
                            <button id ="${task._id}" class="deleteButton">Delete</button>
                            <button class="updateButton" id="${task._id}">Update</button>
                        </div>`);

                        // Clear the form input fields
                        $('#name').val('');
                        $('#description').val('');
                        $('#category').val('');
                        $('#label').val('');
                        $('#dueDate').val('');
                        $('#priority').val(0);


                        // Display success message
                        $('#messages').text('Task created successfully!');
                    },
                    error: function (xhr, status, error) {
                        console.error('Error:', error);
                        // Handle error here
                        $("#messages").text("Error: ", error);
                    }
                });
            });
        </script>

        <%- include('footer') %>